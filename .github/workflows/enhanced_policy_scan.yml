name: Enhanced Policy Compliance Scan

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * 1'  # Run weekly on Mondays at 2 AM

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: üîí Security Policy Scan
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better scanning

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements-dev.txt --no-deps

      - name: Make Scripts Executable
        run: |
          chmod +x src/enhanced_cli.py
          chmod +x src/advanced_scanner.py

      - name: Run Enhanced Policy Scanner
        run: |
          python src/enhanced_cli.py scan . --format json --output security_report || echo "Enhanced scanner failed, continuing..."
        continue-on-error: true

      - name: Run Advanced Security Scanner
        run: |
          python src/advanced_scanner.py || echo "Advanced scanner failed, continuing..."
        continue-on-error: true

      - name: Generate Security Summary
        run: |
          echo "Security scan completed" > security_summary.txt
          if [ -f "security_report.json" ]; then
            echo "Policy report generated successfully" >> security_summary.txt
          else
            echo "No policy report generated" >> security_summary.txt
          fi

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: |
            security_report.json
            security_report.html
            security_summary.txt
            *.json
            *.html

  dependency-scan:
    runs-on: ubuntu-latest
    name: üì¶ Dependency Vulnerability Scan
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Security Tools
        run: |
          pip install safety bandit semgrep

      - name: Run Safety Check
        run: |
          safety check --json --output safety-report.json || echo "Safety check failed"
        continue-on-error: true

      - name: Run Bandit Security Scan
        run: |
          bandit -r . -f json -o bandit-report.json || echo "Bandit scan failed"
        continue-on-error: true

      - name: Run Semgrep
        run: |
          semgrep ci --json --output semgrep-report.json || echo "Semgrep scan failed"
        continue-on-error: true

      - name: Upload Dependency Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-reports
          path: |
            safety-report.json
            bandit-report.json
            semgrep-report.json

  code-quality:
    runs-on: ubuntu-latest
    name: üîç Code Quality Analysis
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements-dev.txt --no-deps

      - name: Download Dependency Reports
        uses: actions/download-artifact@v4
        with:
          name: dependency-reports
          path: ./reports

      - name: Run Code Quality Checks
        run: |
          echo "Running code quality checks..."
          black --check --diff src/ || echo "Black formatting issues found"
          flake8 src/ --max-line-length=120 || echo "Flake8 linting issues found"
          mypy src/ --ignore-missing-imports || echo "MyPy type checking issues found"
          echo "Code quality checks completed"

      - name: Generate Quality Report
        run: |
          echo "Code Quality Analysis Complete" > quality_report.txt
          echo "Black formatting: $(black --check --diff src/ 2>&1 | wc -l) issues" >> quality_report.txt
          echo "Flake8 linting: $(flake8 src/ --max-line-length=120 2>&1 | wc -l) issues" >> quality_report.txt

      - name: Upload Quality Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: |
            quality_report.txt
            reports/

  compliance-report:
    runs-on: ubuntu-latest
    name: üìä Compliance Report Generation
    needs: [security-scan, dependency-scan, code-quality]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Reports
        uses: actions/download-artifact@v4
        with:
          name: security-report
          path: ./security-reports

      - name: Download Dependency Reports
        uses: actions/download-artifact@v4
        with:
          name: dependency-reports
          path: ./dependency-reports

      - name: Download Quality Reports
        uses: actions/download-artifact@v4
        with:
          name: quality-reports
          path: ./quality-reports

      - name: Generate Compliance Summary
        run: |
          echo "# DevSecOps Policy Scanner Compliance Report" > compliance_summary.md
          echo "Generated on: $(date)" >> compliance_summary.md
          echo "" >> compliance_summary.md
          echo "## Security Scan Results" >> compliance_summary.md
          if [ -f "./security-reports/security_report.json" ]; then
            echo "- Security policy scan completed" >> compliance_summary.md
          else
            echo "- Security policy scan failed" >> compliance_summary.md
          fi
          echo "" >> compliance_summary.md
          echo "## Dependency Scan Results" >> compliance_summary.md
          if [ -f "./dependency-reports/safety-report.json" ]; then
            echo "- Dependency vulnerability scan completed" >> compliance_summary.md
          else
            echo "- Dependency vulnerability scan failed" >> compliance_summary.md
          fi
          echo "" >> compliance_summary.md
          echo "## Code Quality Results" >> compliance_summary.md
          if [ -f "./quality-reports/quality_report.txt" ]; then
            echo "- Code quality analysis completed" >> compliance_summary.md
          else
            echo "- Code quality analysis failed" >> compliance_summary.md
          fi

      - name: Upload Compliance Summary
        uses: actions/upload-artifact@v4
        with:
          name: compliance-summary
          path: compliance_summary.md

  notification:
    runs-on: ubuntu-latest
    name: üì¢ Notification
    needs: [compliance-report]
    if: always()
    
    steps:
      - name: Download Compliance Summary
        uses: actions/download-artifact@v4
        with:
          name: compliance-summary
          path: ./summary

      - name: Send Notification
        run: |
          if [ -f "./summary/compliance_summary.md" ]; then
            echo "‚úÖ Policy compliance scan completed successfully"
            echo "üìä Summary report generated"
          else
            echo "‚ùå Policy compliance scan failed"
            echo "Continuing with workflow..."
          fi 